<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Rạp</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{/css/animate.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/font-awesome.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/fonts.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/flaticon.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/owl.carousel.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/owl.theme.default.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/dl-menu.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/venobox.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/plugin/rs_slider/layers.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/plugin/rs_slider/navigation.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/plugin/rs_slider/settings.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/responsive.css}" />

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" th:href="@{/images/header/favicon.ico}" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #2d3436;
            line-height: 1.6;
            padding: 0px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 30px;
            transition: transform 0.3s ease;
        }

        .container:hover {
            transform: translateY(-5px);
        }

        h1 {
            font-size: 2.5rem;
            color: #e74c3c;
            text-align: center;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        h2 {
            font-size: 1.8rem;
            color: #2d3436;
            text-align: center;
            margin-bottom: 20px;
        }

        .theater-info {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .theater-info img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: opacity 0.3s ease;
        }

        .theater-info img:hover {
            opacity: 0.95;
        }

        .theater-info p {
            font-size: 1.1rem;
            color: #636e72;
            margin: 5px 0;
        }

        .theater-info strong {
            color: #2d3436;
        }

        .date-picker {
            text-align: center;
            margin-bottom: 20px;
        }

        .date-picker label {
            font-size: 1.2rem;
            color: #2d3436;
            margin-right: 10px;
        }

        .date-picker select {
            padding: 8px;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #636e72;
            background: #f1f3f5;
            cursor: pointer;
        }

        .schedule-container {
            margin: 30px 0;
            min-height: 0;
        }

        .schedule {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            background: #f1f3f5;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .schedule:hover {
            background: #dfe6e9;
        }

        .schedule .poster-column {
            flex: 0 0 auto;
            margin-right: 40px;
        }

        .schedule .poster-column img {
            max-width: 100px;
            height: auto;
            border-radius: 4px;
        }

        .schedule .info-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .schedule .info-column span {
            font-size: 1rem;
            color: #2d3436;
            margin-bottom: 5px;
        }

        .schedule .info-column .showtimes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .schedule .info-column .showtimes a {
            padding: 8px 16px;
            background: #e74c3c;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .schedule .info-column .showtimes a:hover {
            background: #c0392b;
        }

        .no-schedule {
            text-align: center;
            font-size: 1.1rem;
            color: #636e72;
            padding: 20px;
            background: #f1f3f5;
            border-radius: 8px;
        }

        .hidden {
            display: none !important; /* Đảm bảo hidden không chiếm không gian */
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .buttons a {
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .buttons a:first-child {
            background: #6c5ce7;
            color: #fff;
        }

        .buttons a:first-child:hover {
            background: #5a4bc6;
            transform: translateY(-2px);
        }

        .buttons a:last-child {
            background: #00b894;
            color: #fff;
        }

        .buttons a:last-child:hover {
            background: #009874;
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .schedule {
                flex-direction: column;
            }

            .schedule .poster-column {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .schedule .info-column {
                width: 100%;
            }

            .schedule span {
                margin-bottom: 8px;
            }

            .buttons {
                flex-direction: column;
                gap: 10px;
            }

            .buttons a {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>

<!-- Navigation Start -->
<header lang="vi" th:replace="fragments/navigation :: navigation"></header>
<!-- Navigation End -->

<div class="container">
    <h1>THEATER</h1>
    <h2 th:text="${branch.name} + ' - ' + ${branch.diaChi}"></h2>
    <div class="theater-info">
        <img th:src="${branch.imgurl}" alt="Theater Image" th:if="${!#strings.isEmpty(branch.imgurl)}"/>
        <p><strong>Điện thoại:</strong> <span th:text="${branch.phoneNo}"></span></p>
    </div>
    <div class="date-picker">
        <label for="date-select">Chọn ngày:</label>
        <select id="date-select" onchange="filterSchedulesByDate()">
        </select>
    </div>
    <div class="schedule-container" id="schedule-container">
        <div th:each="schedule : ${schedules}" class="schedule schedule-item"
             th:attr="data-date=${#temporals.format(schedule.startTime, 'yyyy-MM-dd')},data-movie-id=${schedule.movie.id}
             ,data-schedule-id=${schedule.id},data-start-time=${#temporals.format(schedule.startTime, 'HH:mm')}
             ,data-end-date=${#temporals.format(schedule.endDate, 'yyyy-MM-dd')},data-format=${schedule.format}
             ,data-release-date=room_+0+${schedule.roomId},data-movie-name=${schedule.movie.name}
             ,data-poster=${schedule.movie.smallImageUrl}">
            <!-- Data stored in attributes, displayed dynamically -->
        </div>
        <div th:if="${#lists.isEmpty(schedules)}" class="no-schedule">
            <p>Không có lịch chiếu tại rạp này.</p>
        </div>
    </div>
    <div class="buttons">
        <a th:href="${schedules.isEmpty() ? '#' : schedules[0].map}" th:text="'XEM BẢN ĐỒ'" target="_blank"></a>
        <a th:href="@{/contact}">LIÊN HỆ CINEMA</a>
    </div>
</div>
<script>
    function populateDatePicker() {
        const select = document.getElementById('date-select');
        const today = new Date();
        const options = [];

        for (let i = 0; i < 14; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const displayDate = date.toLocaleDateString('vi-VN', { weekday: 'short', day: '2-digit', month: '2-digit' });
            options.push(`<option value="${dateStr}">${displayDate}</option>`);
        }

        select.innerHTML = options.join('');
        const savedDate = localStorage.getItem('selectedDate');
        if (savedDate && new Date(savedDate) >= today) {
            select.value = savedDate;
        } else {
            select.value = today.toISOString().split('T')[0];
        }
    }

    // Filter schedules by selected date and group by unique movies
    function filterSchedulesByDate() {
        const selectedDate = new Date(document.getElementById('date-select').value);
        const schedules = document.getElementsByClassName('schedule-item');
        const container = document.getElementById('schedule-container');
        const uniqueMovies = new Map();

        // Debug: Log selected date
        console.log('Selected Date:', selectedDate.toISOString().split('T')[0]);

        // Hide all schedules initially
        Array.from(schedules).forEach(schedule => schedule.classList.add('hidden'));

        // Group schedules by movie ID and filter by end_date
        Array.from(schedules).forEach(schedule => {
            const scheduleDate = new Date(schedule.getAttribute('data-date'));
            const endDate = new Date(schedule.getAttribute('data-end-date'));
            const movieId = schedule.getAttribute('data-movie-id');

            // Debug: Log schedule details
            console.log('Schedule:', {
                date: scheduleDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                movieId
            });

            if (!isNaN(scheduleDate) && !isNaN(endDate) && scheduleDate <= selectedDate && selectedDate <= endDate) {
                schedule.classList.remove('hidden'); // Hiển thị schedule nếu khớp
                if (!uniqueMovies.has(movieId)) {
                    uniqueMovies.set(movieId, []);
                }
                uniqueMovies.get(movieId).push({
                    scheduleId: schedule.getAttribute('data-schedule-id'),
                    startTime: schedule.getAttribute('data-start-time'),
                    format: schedule.getAttribute('data-format'),
                    releaseDate: schedule.getAttribute('data-release-date'),
                    movieName: schedule.getAttribute('data-movie-name'),
                    poster: schedule.getAttribute('data-poster')
                });
            }
        });

        // Clear existing displayed schedules and regenerate
        const existingSchedules = container.querySelectorAll('.schedule.displayed');
        existingSchedules.forEach(schedule => {
            if (!schedule.classList.contains('schedule-item')) {
                schedule.remove();
            }
        });

        // Display schedules for each unique movie
        let hasSchedules = false;
        uniqueMovies.forEach((showtimes, movieId) => {
            const movie = showtimes[0];
            showtimes.sort((a, b) => a.startTime.localeCompare(b.startTime));
            const scheduleDiv = document.createElement('div');
            scheduleDiv.className = 'schedule displayed';
            scheduleDiv.innerHTML = `
                <div class="poster-column">
                    <img src="${movie.poster || ''}" alt="Movie Poster" ${!movie.poster ? 'style="display:none;"' : ''}/>
                </div>
                <div class="info-column">
                    <span>${movie.movieName || 'N/A'}</span>
                    <span>${movie.format || 'N/A'}</span>
                    <span>${movie.releaseDate || 'N/A'}</span>
                    <div class="showtimes">
                        ${showtimes.map(showtime => `
                            <a href="/book-ticket?scheduleId=${showtime.scheduleId}">${showtime.startTime}</a>
                        `).join('')}
                    </div>
                </div>
            `;
            container.insertBefore(scheduleDiv, container.querySelector('.no-schedule'));
            hasSchedules = true;
        });

        // Show/hide no-schedule message
        const noScheduleDiv = container.querySelector('.no-schedule');
        if (noScheduleDiv) {
            noScheduleDiv.style.display = hasSchedules ? 'none' : 'block';
        }

        // Save selected date to localStorage
        localStorage.setItem('selectedDate', selectedDate.toISOString().split('T')[0]);

        // Remove any leftover hidden schedules to avoid whitespace
        Array.from(schedules).forEach(schedule => {
            if (schedule.classList.contains('hidden') && schedule.classList.contains('schedule-item')) {
                schedule.style.display = 'none'; // Đảm bảo không chiếm không gian
            }
        });
    }

    // Initialize date picker and filter on page load
    document.addEventListener('DOMContentLoaded', () => {
        populateDatePicker();
        filterSchedulesByDate();
    });
</script>
</body>
</html>