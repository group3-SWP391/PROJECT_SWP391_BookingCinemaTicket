<!DOCTYPE html>
<html lang="zxx" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Movie-Details</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta name="description" content="Movie Pro" />
    <meta name="keywords" content="Movie Pro" />
    <meta name="author" content="" />
    <meta name="MobileOptimized" content="320" />
    <!-- Template styles -->
    <link rel="stylesheet" type="text/css" th:href="@{/css/animate.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/font-awesome.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/fonts.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/flaticon.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/owl.carousel.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/owl.theme.default.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/dl-menu.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/venobox.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/plugin/rs_slider/layers.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/plugin/rs_slider/navigation.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/plugin/rs_slider/settings.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/responsive.css}" />
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" th:href="@{/images/header/favicon.ico}" />
    <style>
        .tab-button {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background-color: white;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }

        .tab-button.active {
            background-color: black;
            color: white;
        }

        .tab-content {
            display: none;
            margin-top: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .pagination ul {
            list-style: none;
            display: flex;
            gap: 5px;
            padding: 0;
        }

        .pagination li a {
            padding: 6px 12px;
            text-decoration: none;
            background-color: #f0f0f0;
            color: #333;
            border-radius: 4px;
        }

        .pagination li.active a {
            background-color: #007bff;
            color: white;
        }

    </style>
</head>
<body>
<!-- Preloader Start -->
<div id="preloader">
    <div id="status">
        <img th:src="@{/images/header/horoscope.gif}" id="preloader_image" alt="loader" />
    </div>
</div>
<!-- Navigation Start -->
<header lang="vi" th:replace="fragments/navigation :: navigation"></header>
<!-- Navigation End -->

<!-- Title Wrapper Start -->
<div class="prs_title_main_sec_wrapper">
    <div class="prs_title_img_overlay"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="prs_title_heading_wrapper">
                    <h2>Th·ªÉ lo·∫°i phim</h2>
                    <ul>
                        <li><a th:href="@{/}">Home</a></li>
                        <li> > Movie Category</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Title Wrapper End -->
<div class="container">
    <h1 th:text="${movie.name}">T√™n phim</h1>
    <img th:src="${movie.smallImageUrl}" alt="Poster" style="width: 300px; height: auto;" />
    <p><strong>Th·ªÉ lo·∫°i:</strong> <span th:text="${movie.categories}">Th·ªÉ lo·∫°i</span></p>
    <p><strong>Th·ªùi l∆∞·ª£ng:</strong> <span th:text="${movie.duration + ' minutes'}">Th·ªùi l∆∞·ª£ng</span></p>
    <p><strong>Kh·ªüi chi·∫øu:</strong> <span th:text="${#temporals.format(movie.releaseDate, 'yyyy-MM-dd')}">Ng√†y kh·ªüi chi·∫øu</span></p>
    <!-- N√∫t y√™u th√≠ch -->
    <form th:action="@{/favorite/toggle}" method="post" style="display: inline;">
        <input type="hidden" name="movieId" th:value="${movie.id}" />
        <button type="submit" style="background: none; border: none;">
            <i class="fa" th:classappend="${isFavorite} ? ' fa-heart text-danger' : ' fa-heart-o'"></i>
        </button>
    </form>

    <p><strong>T√≥m t·∫Øt:</strong> <span th:text="${movie.longDescription}">T√≥m t·∫Øt</span></p>
    <div class="tab-section">
        <div style="display: flex; align-items: center; gap: 10px;">
            <h3>B√¨nh lu·∫≠n (<span th:text="${comments.size()}">0</span>)</h3>
            <h3>ƒê√°nh gi√° (<span th:text="${reviews.size()}">0</span>)</h3>
            <div style="margin-left: auto;">
                <button onclick="showTab('comment')" id="btn-comment" class="tab-button active">B√¨nh lu·∫≠n</button>
                <button onclick="showTab('review')" id="btn-review" class="tab-button">ƒê√°nh gi√°</button>
            </div>
        </div>

        <!-- COMMENT TAB -->
        <div id="comment-tab" class="tab-content active">
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
            <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>

            <div th:if="${comments != null and #lists.isEmpty(comments)}">
                <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
            </div>

            <div th:if="${session.userLogin == null}">
                <p>Vui l√≤ng <a th:href="@{/login}">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
            </div>

            <div th:if="${session.userLogin != null and !hasOrdered}">
                <p style="color: red;">B·∫°n c·∫ßn xem phim tr∆∞·ªõc khi ƒë√°nh gi√° b·ªô phim nh√©.</p>
            </div>

            <div th:if="${session.userLogin != null and hasOrdered}">
                <form th:action="@{/addComment}" method="post">
                    <input type="hidden" name="movieId" th:value="${movie.id}" />
                    <label for="content">Vi·∫øt b√¨nh lu·∫≠n:</label><br />
                    <textarea name="content" id="content" rows="4" cols="50" required></textarea><br />
                    <button type="submit">G·ª≠i b√¨nh lu·∫≠n</button>
                </form>
            </div>

            <div id="comment-list">
                <div th:each="comment, iterStat : ${comments}"
                     th:class="${iterStat.index < 10} ? 'comment-item' : 'comment-item hidden'"
                     style="border: 1px solid #ddd; margin-bottom: 15px; padding: 10px;">

                    <p><strong th:text="${comment.user.fullname}">Ng∆∞·ªùi d√πng</strong> ƒë√£ b√¨nh lu·∫≠n:</p>
                    <p th:text="${comment.content}">N·ªôi dung</p>
                    <p><i>Th·ªùi gian:</i>
                        <span th:text="${#temporals.format(comment.createdAt, 'dd/MM/yyyy HH:mm')}">---</span>
                    </p>

                    <!-- Like / Dislike -->
                    <form th:action="@{/like}" method="post" style="display:inline;">
                        <input type="hidden" name="commentId" th:value="${comment.id}" />
                        <input type="hidden" name="movieId" th:value="${movie.id}" />
                        <button type="submit">üëç <span th:text="${likesMap[comment.id]}">0</span></button>
                    </form>
                    <form th:action="@{/dislike}" method="post" style="display:inline;">
                        <input type="hidden" name="commentId" th:value="${comment.id}" />
                        <input type="hidden" name="movieId" th:value="${movie.id}" />
                        <button type="submit">üëé <span th:text="${dislikesMap[comment.id]}">0</span></button>
                    </form>

                    <!-- N·∫øu l√† ch·ªß b√¨nh lu·∫≠n th√¨ hi·ªán n√∫t ch·ªânh s·ª≠a/x√≥a -->
                    <div th:if="${session.userLogin != null and session.userLogin.id == comment.user.id}" style="margin-top: 10px;">
                        <button type="button" th:attr="onclick=|toggleEditForm(${comment.id})|">Ch·ªânh s·ª≠a</button>

                        <form th:action="@{/deleteComment}" method="post" style="display: inline;"
                              onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?');">
                            <input type="hidden" name="commentId" th:value="${comment.id}" />
                            <input type="hidden" name="movieId" th:value="${movie.id}" />
                            <button type="submit">X√≥a</button>
                        </form>

                        <!-- Form ch·ªânh s·ª≠a b√¨nh lu·∫≠n -->
                        <form th:action="@{/editComment}" method="post"
                              th:attr="id=|edit-form-${comment.id}|" style="display: none; margin-top: 10px;">
                            <input type="hidden" name="commentId" th:value="${comment.id}" />
                            <input type="hidden" name="movieId" th:value="${movie.id}" />
                            <textarea name="content" rows="3" cols="50" th:text="${comment.content}" required></textarea><br/>
                            <button type="submit">L∆∞u ch·ªânh s·ª≠a</button>
                        </form>
                    </div>

                    <!-- Reply -->
                    <div th:if="${session.userLogin != null}" style="margin-top: 10px;">
                        <button type="button" th:attr="onclick=|toggleReplyForm(${comment.id})|">Tr·∫£ l·ªùi</button>
                        <form th:action="@{/replyComment}" method="post"
                              th:attr="id=|reply-form-${comment.id}|" style="display: none; margin-top: 10px;">
                            <input type="hidden" name="movieId" th:value="${movie.id}" />
                            <input type="hidden" name="parentCommentId" th:value="${comment.id}" />
                            <textarea name="content" rows="2" cols="50" required placeholder="Tr·∫£ l·ªùi b√¨nh lu·∫≠n..."></textarea><br />
                            <button type="submit">G·ª≠i tr·∫£ l·ªùi</button>
                        </form>
                    </div>
                    <div th:if="${session.userLogin == null}">
                        <p><i>ƒêƒÉng nh·∫≠p ƒë·ªÉ tr·∫£ l·ªùi b√¨nh lu·∫≠n.</i></p>
                    </div>

                    <!-- Replies -->
                    <div style="margin-left: 20px; margin-top: 10px;" th:each="reply : ${comment.replies}">
                        <p>
                            <strong th:text="${reply.user.fullname}">Ng∆∞·ªùi tr·∫£ l·ªùi</strong>:
                            <span th:text="${reply.content}">N·ªôi dung tr·∫£ l·ªùi</span>
                        </p>
                        <p><i>Th·ªùi gian:</i>
                            <span th:text="${#temporals.format(reply.createdAt, 'dd/MM/yyyy HH:mm')}">---</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="pagination">
                <ul>
                    <!-- N√∫t 'Trang tr∆∞·ªõc' -->
                    <li th:if="${commentPage.hasPrevious()}">
                        <a th:href="@{/movie-details(id=${movie.id}, commentPage=${commentPage.number - 1})}">&laquo; Tr∆∞·ªõc</a>
                    </li>

                    <!-- C√°c s·ªë trang -->
                    <li th:each="i : ${#numbers.sequence(0, commentPage.totalPages - 1)}"
                        th:classappend="${i == commentPage.number} ? 'active'">
                        <a th:href="@{/movie-details(id=${movie.id}, commentPage=${i})}"
                           th:text="${i + 1}">1</a>
                    </li>

                    <!-- N√∫t 'Trang sau' -->
                    <li th:if="${commentPage.hasNext()}">
                        <a th:href="@{/movie-details(id=${movie.id}, commentPage=${commentPage.number + 1})}">Sau &raquo;</a>
                    </li>
                </ul>
            </div>
        </div>




        <!-- REVIEW TAB -->
        <div id="review-tab" class="tab-content">
            <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
            <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

            <div th:if="${session.userLogin != null and hasOrdered}">
                <form th:action="@{/submitReview}" method="post">
                    <input type="hidden" name="movieId" th:value="${movie.id}" />
                    <label for="rating">Ch·ªçn s·ªë sao:</label>
                    <select name="rating" id="rating" required>
                        <option value="5">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
                        <option value="4">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
                        <option value="3">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
                        <option value="2">‚≠êÔ∏è‚≠êÔ∏è</option>
                        <option value="1">‚≠êÔ∏è</option>
                    </select><br/><br/>
                    <label for="comment">Nh·∫≠n x√©t:</label><br/>
                    <textarea id="comment" name="comment" rows="3" cols="50" required></textarea><br/>
                    <button type="submit">G·ª≠i ƒë√°nh gi√°</button>
                </form>
            </div>

            <h3>ƒê√°nh gi√° c·ªßa ng∆∞·ªùi xem</h3>
            <div th:if="${#lists.isEmpty(reviews)}">
                <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
            </div>

            <div id="review-list">
                <div th:each="review, iterStat : ${reviews}" th:class="${iterStat.index < 10} ? 'review-item' : 'review-item hidden'" style="border: 1px solid #ddd; padding: 10px; margin-bottom: 15px;">
                    <p><strong th:text="${review.user.fullname}">Ng∆∞·ªùi d√πng</strong> ƒë√£ ƒë√°nh gi√°: <span th:text="${review.rating}">5</span> ‚≠êÔ∏è</p>
                    <p><strong>Nh·∫≠n x√©t:</strong> <span th:text="${review.comment}">N·ªôi dung ƒë√°nh gi√°</span></p>
                    <p><i>Th·ªùi gian:</i> <span th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy HH:mm')}">---</span></p>
                </div>
            </div>
            <div class="pagination">
                <ul>
                    <!-- N√∫t 'Trang tr∆∞·ªõc' -->
                    <li th:if="${reviewPage.hasPrevious()}">
                        <a th:href="@{/movie-details(id=${movie.id}, reviewPage=${reviewPage.number - 1}, tab='review')}">&laquo; Tr∆∞·ªõc</a>
                    </li>

                    <!-- C√°c s·ªë trang -->
                    <li th:each="i : ${#numbers.sequence(0, reviewPage.totalPages - 1)}"
                        th:classappend="${i == reviewPage.number} ? 'active'">
                        <a th:href="@{/movie-details(id=${movie.id}, reviewPage=${i}, tab='review')}"
                           th:text="${i + 1}">1</a>
                    </li>

                    <!-- N√∫t 'Trang sau' -->
                    <li th:if="${reviewPage.hasNext()}">
                        <a th:href="@{/movie-details(id=${movie.id}, reviewPage=${reviewPage.number + 1}, tab='review')}">Sau &raquo;</a>
                    </li>

                </ul>
            </div>
        </div>
        </div>
    </div>


    <!-- prs footer Wrapper Start -->
<header lang="vi" th:include="fragments/footer"></header>
<!-- prs footer Wrapper End -->

<!-- Main JS Files -->
<script th:src="@{/js/jquery_min.js}"></script>
<script th:src="@{/js/bootstrap.js}"></script>
<script th:src="@{/js/modernizr.js}"></script>
<script th:src="@{/js/owl.carousel.js}"></script>
<script th:src="@{/js/jquery.dlmenu.js}"></script>
<script th:src="@{/js/jquery.sticky.js}"></script>
<script th:src="@{/js/jquery.nice-select.min.js}"></script>
<script th:src="@{/js/jquery.magnific-popup.js}"></script>
<script th:src="@{/js/jquery.bxslider.min.js}"></script>
<script th:src="@{/js/venobox.min.js}"></script>
<script th:src="@{/js/smothscroll_part1.js}"></script>
<script th:src="@{/js/smothscroll_part2.js}"></script>
<script th:src="@{/js/jquery.countTo.js}"></script>
<script th:src="@{/js/jquery.inview.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/jquery.themepunch.revolution.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/jquery.themepunch.tools.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.addon.snow.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.actions.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.carousel.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.kenburn.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.layeranimation.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.migration.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.navigation.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.parallax.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.slideanims.min.js}"></script>
<script th:src="@{/js/plugin/rs_slider/revolution.extension.video.min.js}"></script>
<script th:src="@{/js/custom.js}"></script>
<script>
    function toggleReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
</script>

<script>
    function showTab(tab) {
        const commentTab = document.getElementById('comment-tab');
        const reviewTab = document.getElementById('review-tab');
        const btnComment = document.getElementById('btn-comment');
        const btnReview = document.getElementById('btn-review');

        if (tab === 'comment') {
            commentTab.classList.add('active');
            reviewTab.classList.remove('active');
            btnComment.classList.add('active');
            btnReview.classList.remove('active');
        } else {
            commentTab.classList.remove('active');
            reviewTab.classList.add('active');
            btnComment.classList.remove('active');
            btnReview.classList.add('active');
        }
    }

    function toggleReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }
</script>
<script>
    function toggleEditForm(commentId) {
        const form = document.getElementById('edit-form-' + commentId);
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }
</script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        if (tab === 'review') {
            showTab('review');
        } else {
            showTab('comment'); // m·∫∑c ƒë·ªãnh
        }
    });
</script>
</body>
</html>