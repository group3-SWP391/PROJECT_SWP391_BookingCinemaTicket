<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manager Staff</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</head>
<body>
<div th:fragment="content" class="dashboard-content">
    <!-- Nút thêm nhân viên -->
    <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#employeeModal" onclick="openCreateEmployeeModal()">
        <i class="fa fa-plus-circle"></i> Add Employee
    </button>

    <!-- Tiêu đề -->
    <h2 class="text-center">Manager Staff</h2>

    <!-- Bảng danh sách nhân viên -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped movie-table">
            <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>Họ tên</th>
                <th>Tài khoản</th>
                <th>SĐT</th>
                <th>Email</th>
                <th>Vai trò</th>
                <th>Thao tác</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="e : ${employees}">
                <td th:text="${e.id}">1</td>
                <td th:text="${e.fullname}">Tên</td>
                <td th:text="${e.username}">Tài khoản</td>
                <td th:text="${e.phone}">SĐT</td>
                <td th:text="${e.email}">Email</td>
                <td th:text="${e.role.name}">manager</td>
                <td>
                    <button class="btn btn-sm btn-primary"
                            th:attr="onclick=|showEditModal(${e.id})|">
                        <i class="fa fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger"
                            th:attr="onclick=|deleteEmployee(${e.id})|">
                        <i class="fa fa-trash"></i> Fired
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal tạo/sửa nhân viên -->
<div class="modal fade" id="employeeModal" tabindex="-1" role="dialog" aria-labelledby="employeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="employeeModalLabel"><i class="fa fa-user-plus"></i> Nhân viên</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color:white">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <input type="hidden" id="employeeId">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="fullname">Họ tên</label>
                            <input type="text" class="form-control" id="fullname" name="fullname" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="username">Tài khoản</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="phone">SĐT</label>
                            <input type="text" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6" id="passwordField">
                            <label for="password">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" name="password">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="roleId">Vai trò</label>
                            <select class="form-control" id="roleId" name="roleId" required>
                                <option value="">-- Chọn vai trò --</option>
                                <option th:each="r : ${roles}" th:value="${r.id}" th:text="${r.name}">role</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Huỷ</button>
                <button type="button" class="btn btn-primary" onclick="saveEmployee()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript xử lý -->
    <script>
        let deleteId = null;

        function openCreateEmployeeModal() {
        $('#employeeForm')[0].reset();
        $('#employeeId').val('');
        $('#passwordField').show();
        $('#employeeModal').modal('show');
    }

        function showEditModal(id) {
        fetch(`/api/users/${id}`)
            .then(res => res.json())
            .then(data => {
                $('#employeeId').val(data.id);
                $('#fullname').val(data.fullname);
                $('#username').val(data.username);
                $('#phone').val(data.phone);
                $('#email').val(data.email);
                $('#roleId').val(data.role.id);
                $('#passwordField').hide(); // ẩn mật khẩu khi edit
                $('#employeeModal').modal('show');
            });
    }

        function saveEmployee() {
        const id = $('#employeeId').val();
        const employee = {
        fullname: $('#fullname').val(),
        username: $('#username').val(),
        phone: $('#phone').val(),
        email: $('#email').val(),
        roleId: $('#roleId').val()
    };

        if (id) {
        fetch(`/manager/employees/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(employee)
    }).then(() => location.reload());
    } else {
        employee.password = $('#password').val();
        fetch('/manager/employees', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(employee)
    }).then(() => location.reload());
    }
    }

        function deleteEmployee(id) {
        deleteId = id;
        $('#confirmDeleteModal').modal('show');
    }

        $('#confirmDeleteBtn').click(function () {
        if (deleteId) {
        fetch(`/manager/employees/${deleteId}`, {
        method: 'DELETE'
    }).then(() => {
        $('#confirmDeleteModal').modal('hide');
        location.reload();
    });
    }
    });
</script>

<!-- Modal xác nhận xoá -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Xác nhận xoá</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xoá nhân viên này?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Huỷ</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Xoá</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>
