<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>
<div th:fragment="content" class="employee-stage">
        <!-- Employee-themed User Icon -->
        <div class="movie-reel">
            üë•
        </div>
        
        <!-- Dashboard Content Wrapper -->
        <div class="dashboard-content">
            <!-- Add Employee Button -->
            <button type="button" class="btn-add-movie" id="addEmployeeBtn">
                <i class="fa fa-plus-circle"></i> Th√™m Nh√¢n vi√™n M·ªõi
            </button>

            <!-- Employee Management Header -->
            <div class="movie-management-header">
                <h1>
                    <i class="fa fa-users"></i>
                    H·ªá th·ªëng Qu·∫£n l√Ω Nh√¢n vi√™n
                </h1>
            </div>

            <!-- Employee Table Container -->
            <div class="movie-table-container">
                <table class="table movie-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>H·ªç v√† T√™n</th>
                            <th>T√™n ƒëƒÉng nh·∫≠p</th>
                            <th>Li√™n h·ªá</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="e : ${employees}">
                            <td>
                                <strong th:text="${e.id}">1</strong>
                            </td>
                            <td>
                                <strong th:text="${e.fullname}">Full Name</strong>
                                <br>
                                <small class="text-muted" th:text="${e.username}">username</small>
                            </td>
                            <td>
                                <span th:text="${e.username}">username</span>
                            </td>
                            <td>
                                <span th:text="${e.phone}">Phone</span>
                                <br>
                                <small class="text-muted" th:text="${e.email}" th:if="${e.email != null}">email@example.com</small>
                            </td>
                            <td>
                                <span th:if="${e.status}" class="badge badge-success">Ho·∫°t ƒë·ªông</span>
                                <span th:unless="${e.status}" class="badge badge-danger">Kh√¥ng ho·∫°t ƒë·ªông</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="btn-action btn-edit" 
                                            th:data-employee-id="${e.id}"
                                            onclick="editEmployee(this.dataset.employeeId)">
                                        <i class="fa fa-edit"></i> S·ª≠a
                                    </button>
                                    <button type="button" th:if="${e.status}" class="btn-action btn-delete" 
                                            th:data-employee-id="${e.id}"
                                            th:data-employee-name="${e.fullname}"
                                            onclick="fireEmployee(this.dataset.employeeId, this.dataset.employeeName)">
                                        <i class="fa fa-user-times"></i> Sa th·∫£i
                                    </button>
                                    <button type="button" th:unless="${e.status}" class="btn-action btn-success" 
                                            th:data-employee-id="${e.id}"
                                            th:data-employee-name="${e.fullname}"
                                            onclick="activateEmployee(this.dataset.employeeId, this.dataset.employeeName)">
                                        <i class="fa fa-user-plus"></i> K√≠ch ho·∫°t
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Employee Modal -->
        <div class="modal fade" id="employeeModal" tabindex="-1" role="dialog" aria-labelledby="employeeModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="employeeModalLabel">
                            <i class="fa fa-user-plus"></i> Th√™m Nh√¢n vi√™n M·ªõi
                        </h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: white; opacity: 0.8;" onclick="closeEmployeeModal()">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="employeeForm" onsubmit="return false;">
                            <input type="hidden" id="employeeId" name="employeeId">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="employeeFullname">H·ªç v√† T√™n *</label>
                                        <input type="text" class="form-control" id="employeeFullname" name="fullname" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="employeeUsername">T√™n ƒëƒÉng nh·∫≠p *</label>
                                        <input type="text" class="form-control" id="employeeUsername" name="username" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="employeePhone">S·ªë ƒëi·ªán tho·∫°i *</label>
                                        <input type="text" class="form-control" id="employeePhone" name="phone" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="employeeEmail">Email</label>
                                        <input type="email" class="form-control" id="employeeEmail" name="email">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6" id="passwordField">
                                    <div class="form-group">
                                        <label for="employeePassword">M·∫≠t kh·∫©u <span id="passwordRequired">*</span></label>
                                        <input type="password" class="form-control" id="employeePassword" name="password">
                                        <small class="form-text text-muted" id="passwordHelp" style="display: none;">ƒê·ªÉ tr·ªëng ƒë·ªÉ gi·ªØ m·∫≠t kh·∫©u hi·ªán t·∫°i</small>
                                    </div>
                                </div>
                                <div class="col-md-6" id="confirmPasswordField">
                                    <div class="form-group">
                                        <label for="employeeConfirmPassword">X√°c nh·∫≠n M·∫≠t kh·∫©u <span id="confirmPasswordRequired">*</span></label>
                                        <input type="password" class="form-control" id="employeeConfirmPassword" name="confirmPassword">
                                        <small class="form-text text-danger" id="passwordMismatch" style="display: none;">M·∫≠t kh·∫©u kh√¥ng kh·ªõp</small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeEmployeeModal()">H·ªßy</button>
                        <button type="button" class="btn-save-movie" onclick="saveEmployee()">L∆∞u Nh√¢n vi√™n</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fire Confirmation Modal -->
        <div class="modal fade" id="confirmFireModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">X√°c nh·∫≠n Sa th·∫£i Nh√¢n vi√™n</h5>
                        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën sa th·∫£i nh√¢n vi√™n n√†y kh√¥ng?</p>
                        <p><strong id="employeeNameToFire"></strong></p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                        <button id="confirmFireBtn" class="btn btn-danger">Sa th·∫£i Nh√¢n vi√™n</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activate Confirmation Modal -->
        <div class="modal fade" id="confirmActivateModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">X√°c nh·∫≠n K√≠ch ho·∫°t Nh√¢n vi√™n</h5>
                        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k√≠ch ho·∫°t nh√¢n vi√™n n√†y kh√¥ng?</p>
                        <p><strong id="employeeNameToActivate"></strong></p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                        <button id="confirmActivateBtn" class="btn btn-success">K√≠ch ho·∫°t Nh√¢n vi√™n</button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        let employeeIdToFire = null;

        // Add Employee Button Click
        document.getElementById('addEmployeeBtn').addEventListener('click', function() {
            openCreateEmployeeModal();
        });

        function openCreateEmployeeModal() {
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeModalLabel').innerHTML = '<i class="fa fa-user-plus"></i> Th√™m Nh√¢n vi√™n M·ªõi';
            document.getElementById('passwordField').style.display = 'block';
            document.getElementById('confirmPasswordField').style.display = 'block';
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('confirmPasswordRequired').style.display = 'inline';
            document.getElementById('passwordHelp').style.display = 'none';
            document.getElementById('passwordMismatch').style.display = 'none';
            document.getElementById('employeePassword').required = true;
            document.getElementById('employeeConfirmPassword').required = true;
            $('#employeeModal').modal('show');
        }

        function editEmployee(id) {
            fetch(`/manager/employees/${id}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('employeeId').value = data.id;
                    document.getElementById('employeeFullname').value = data.fullname;
                    document.getElementById('employeeUsername').value = data.username;
                    document.getElementById('employeePhone').value = data.phone;
                    document.getElementById('employeeEmail').value = data.email;
                    document.getElementById('employeeModalLabel').innerHTML = '<i class="fa fa-edit"></i> S·ª≠a Nh√¢n vi√™n';
                    document.getElementById('passwordField').style.display = 'block';
                    document.getElementById('confirmPasswordField').style.display = 'none';
                    document.getElementById('passwordRequired').style.display = 'none';
                    document.getElementById('passwordHelp').style.display = 'block';
                    document.getElementById('passwordMismatch').style.display = 'none';
                    document.getElementById('employeePassword').required = false;
                    document.getElementById('employeePassword').value = '';
                    document.getElementById('employeeConfirmPassword').value = '';
                    $('#employeeModal').modal('show');
                })
                .catch(error => {
                    console.error('Error fetching employee:', error);
                    alert('L·ªói khi t·∫£i d·ªØ li·ªáu nh√¢n vi√™n');
                });
        }

        function saveEmployee() {
            const id = document.getElementById('employeeId').value;
            const password = document.getElementById('employeePassword').value;
            const confirmPassword = document.getElementById('employeeConfirmPassword').value;
            
            // Password validation for new employees
            if (!id && password !== confirmPassword) {
                document.getElementById('passwordMismatch').style.display = 'block';
                return;
            } else {
                document.getElementById('passwordMismatch').style.display = 'none';
            }

            const employee = {
                fullname: document.getElementById('employeeFullname').value,
                username: document.getElementById('employeeUsername').value,
                phone: document.getElementById('employeePhone').value,
                email: document.getElementById('employeeEmail').value
            };

            if (id) {
                // Update existing employee
                if (password && password.trim() !== '') {
                    employee.password = password;
                }
                
                fetch(`/manager/employees/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(employee)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        $('#employeeModal').modal('hide');
                        location.reload();
                    } else {
                        alert(data.message || 'L·ªói khi c·∫≠p nh·∫≠t nh√¢n vi√™n');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('L·ªói khi c·∫≠p nh·∫≠t nh√¢n vi√™n');
                });
            } else {
                // Create new employee
                employee.password = password;
                fetch('/manager/employees', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(employee)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        $('#employeeModal').modal('hide');
                        location.reload();
                    } else {
                        alert(data.message || 'L·ªói khi t·∫°o nh√¢n vi√™n');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('L·ªói khi t·∫°o nh√¢n vi√™n');
                });
            }
        }

        function fireEmployee(id, name) {
            employeeIdToFire = id;
            document.getElementById('employeeNameToFire').textContent = name;
            $('#confirmFireModal').modal('show');
        }

        function activateEmployee(id, name) {
            employeeIdToFire = id;
            document.getElementById('employeeNameToActivate').textContent = name;
            $('#confirmActivateModal').modal('show');
        }

        function closeEmployeeModal() {
            $('#employeeModal').modal('hide');
        }

        // Fire confirmation
        document.getElementById('confirmFireBtn').addEventListener('click', function() {
            if (employeeIdToFire) {
                fetch(`/manager/employees/${employeeIdToFire}/fire`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        $('#confirmFireModal').modal('hide');
                        location.reload();
                    } else {
                        alert(data.message || 'L·ªói khi sa th·∫£i nh√¢n vi√™n');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('L·ªói khi sa th·∫£i nh√¢n vi√™n');
                });
            }
        });

        // Activate confirmation
        document.getElementById('confirmActivateBtn').addEventListener('click', function() {
            if (employeeIdToFire) {
                fetch(`/manager/employees/${employeeIdToFire}/activate`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        $('#confirmActivateModal').modal('hide');
                        location.reload();
                    } else {
                        alert(data.message || 'L·ªói khi k√≠ch ho·∫°t nh√¢n vi√™n');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('L·ªói khi k√≠ch ho·∫°t nh√¢n vi√™n');
                });
            }
        });
    </script>
</div>
</body>
</html>